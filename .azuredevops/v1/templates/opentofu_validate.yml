# Requirements:
# - OpenTofu is installed on pipeline agent

parameters:
- name: enabled
  type: boolean
  default: true

- name: continueOnError
  type: boolean
  default: false

steps:
- task: AzureCLI@2
  displayName: 'Export secrets'
  inputs:
    azureSubscription: pers-reg-dev-eu-krijn
    scriptType: bash
    addSpnToEnvironment: true
    scriptLocation: inlineScript
    inlineScript: |
      SubId=$(az account show -query id -output tsv)
      export ARM_CLIENT_ID=$servicePrincipalId
      export ARM_CLIENT_SECRET=$servicePrincipalKey
    workingDirectory: $(Build.Repository.LocalPath)/terraform/01_terraform_backend/dev/

- task: AzureCLI@2
  displayName: 'OpenTofu init'
  inputs:
    azureSubscription: pers-reg-dev-eu-krijn
    scriptType: bash
    addSpnToEnvironment: true
    scriptLocation: inlineScript
    inlineScript: |
      echo "Current working directory: $(pwd)"
      tofu init 
    workingDirectory: $(Build.Repository.LocalPath)/terraform/01_terraform_backend/dev/

- task: AzureCLI@2
  displayName: 'OpenTofu plan'
  inputs:
    azureSubscription: pers-reg-dev-eu-krijn
    scriptType: bash
    addSpnToEnvironment: true
    scriptLocation: inlineScript
    inlineScript: |
      tofu plan
    workingDirectory: $(Build.Repository.LocalPath)/terraform/01_terraform_backend/dev/
