# Requirements:
# - OpenTofu is installed on pipeline agent
# - opentofu init

parameters:
- name: enabled
  type: boolean
  default: true

- name: continueOnError
  type: boolean
  default: false

- name: openTofuDir
  type: string

- name: openTofuPlanArtifactPath
  type: string
  default: $(Pipeline.Workspace)/opentofu

steps:
- task: DownloadPipelineArtifact@2
  displayName: Download plan
  inputs:
    artifactName: opentofu_plan
    targetPath: ${{ parameters.openTofuPlanArtifactPath }}

- task: AzureCLI@2
  displayName: OpenTofu apply
  inputs:
    azureSubscription: pers-reg-dev-eu-krijn
    scriptType: bash
    addSpnToEnvironment: true
    scriptLocation: inlineScript
    inlineScript: |
      tofu apply ${{ parameters.openTofuPlanArtifactPath }}/plan.out
    workingDirectory: ${{ parameters.openTofuDir }}
